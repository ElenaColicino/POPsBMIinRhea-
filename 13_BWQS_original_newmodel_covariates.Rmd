---
title: "BWQS - Timepoints"
author: Colicino Lab
output:
  html_document:
    df_print: paged
date: "`r format(Sys.Date(),'%B %d, %Y')`"
---
---

```{r setup, echo=FALSE, warning=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(readxl)
library(lmerTest)
library(kableExtra)
library(lars) 
library(lasso2) 
library(mvtnorm) 
library(SuppDists) 
library(MCMCpack) 
library(grplasso) 
library(magic)
library(kernlab)
library(MASS)
library(fields)
library(stats)
library(rjags)
library(BWQS)
library(devtools)

```

# Introduction

Outcomes:

+ **Body Mass Index** (*bmi*): continuous outcome, regression analysis

We use the POP chemicals because we have the largest number of observation to use: 280 for each timepoints.
All the POP values are log10 trasformed:

+ **POP** (*HCB*,*DDE*,*PCB118*,*PCB153*,*PCB138*,*PCB156*,*PCB180*,*PCB170*)

The covariates used for all the analysis are the following:

+ **gender** (*gender*): 0 = male, 1 = female, male reference group.
+ **maternal age** (*mage*): in years
+ **maternal education** (*m_educ*): 1 = low, 2 = medium, 3 = high (--> to be confirmed)
+ **parity** (*parity*): binary variable {0,1}
+ **maternal bmi pre-pregancy** (*bmi_pre*) 
+ **colesterol (TO EVALUATE)**

We also use the **age af the child** (*age*) to perform a timepoint analysis for the mixture

```{r dataset_cleaning, echo=FALSE}
# load dataset
DT = read_xls("J:/PM/Colicino_Lab/Manuscripts/2020_Chatzi_USC/Data/base_long3.xls")
DT = as.data.table(DT)
#remove the outlier ID 392003
DT = DT[!childid %in% "392003"]

# list of chermicals and covariates
pop = c('HCB','DDE','PCB118','PCB153','PCB138','PCB156','PCB180','PCB170')
covariates = c("gender","mage","m_educ","parity","bmi_pre","age","m_chol", "m_trigl")

DT_pop = DT[,c('childid', 'timepoint', 'motherid', covariates, pop, "bmi"), with=F]
DT_pop = DT_pop[complete.cases(DT_pop)]
id_complete_cases = DT_pop[,.N,by=childid][N==3, childid]
DT_pop = DT_pop[childid %in% id_complete_cases]
DT_pop[, gender := as.numeric(gender-1)]

X = DT_pop[,c(pop),with=F][!duplicated(DT_pop[,pop,with=F])]


# Quantile for pops
Xq = matrix(NA,NROW(X),NCOL(X))
colnames(Xq) = colnames(X)
for(i in 1:NCOL(X)) Xq[,i] = ecdf(X[[colnames(X)[i]]])(X[[colnames(X)[i]]])*3
X = as.data.frame(Xq)

Y = dcast(DT_pop, childid ~ timepoint, value.var = "bmi")[,c(2,3,4)]
Age = dcast(DT_pop, childid ~ timepoint, value.var = "age")[,c(2,3,4)]
Age = Age-mean(Age$`4`)
C = DT_pop[,c('childid',covariates[-6]),with=F][!duplicated(DT_pop[,c('childid',covariates[-6]),with=F])]
C[,':='(edu1 = ifelse(m_educ==1,1,0),
        edu2 = ifelse(m_educ==2,1,0),
        edu3 = ifelse(m_educ==3,1,0))]
C = C[,.(gender,mage,parity,bmi_pre,edu2,edu3,m_chol,m_trigl)]
cols = c('mage','bmi_pre',"m_chol", "m_trigl")
C[ , (cols) := lapply(.SD, scale, center=T, scale=T), .SDcols = cols]
N = nrow(X)
timepoints = ncol(Age)
Q = ncol(C)
P = ncol(X)
alpha_w = rep(1,P)
```

# Overall analysis  

## Bayesian Weighted Quantile Sum Regression

```{r BWQS_time_q, fig.align='center', echo=F}
mix_bwqs_model = 
"model {
for(i in 1:N) {
  for(t in 1:timepoints) {
    Y[i,t] ~ dnorm(mu[i,t], Y.tau[t])
    mu[i,t] <- a[i] + c[i]*Age[i,t] 
  }
  c[i] ~ dnorm(c.mean[i], c.tau)
  a[i] ~ dnorm(a.mean[i], a.tau)
  c.mean[i] <- gamma1 + gamma3*(X[i,1:P] %*% What[1:P]) 
  a.mean[i] <- gamma0 + gamma2*(X[i,1:P] %*% Wtilde[1:P]) + (C[i,1:Q] %*% delta[1:Q]) 
}

for(t in 1:timepoints){
Y.tau.s[t] ~ dunif(0,3)
Y.tau[t] <- 1/(Y.tau.s[t]*Y.tau.s[t])
}

a.tau <- 1/(a.sigma*a.sigma)
a.sigma ~ dunif(0,5)
c.tau <- 1/(c.sigma*c.sigma)
c.sigma ~ dunif(0,5)
gamma0 ~ dnorm(0, 1.0E-04)
gamma1 ~ dnorm(0, 1.0E-04)
gamma2 ~ dnorm(0, 1.0E-04)
gamma3 ~ dnorm(0, 1.0E-04)
Wtilde ~  ddirich(alpha_w)
What ~  ddirich(alpha_w)
for(q in 1:Q) { delta[q] ~ dnorm(0, 1.0E-06) }
}"

jdata <- list(Y=Y, X=X, N=N, alpha_w = alpha_w, Age=Age, C=C, P=P, Q=Q, timepoints=timepoints)
var.s <- c("Wtilde","What","gamma0","gamma1","gamma2","gamma3","a.tau","c.tau")
model.fit <- jags.model(file=textConnection(mix_bwqs_model), data=jdata, n.chains=2, n.adapt=5000, quiet=T)
update(model.fit, n.iter=5000, progress.bar="none")
model.fit <- coda.samples(model=model.fit, variable.names=var.s, n.iter=300000, thin=60, progress.bar="none")
sm = summary(model.fit)

p_table = data.table(Parameters  = c(paste0("Wh_",pop),paste0("Wt_",pop),
                                     "sigma_a","sigma_c",
                                     "gamma0","gamma1","gamma2","gamma3"),
                     Mean        = format(round(sm$statistics[,1],3), digits=3, nsmall=3), 
                     `2.5% CrI`  = format(round(sm$quantiles[,1],3), digits=3, nsmall=3),
                     `97.5% CrI` = format(round(sm$quantiles[,5],3), digits=3, nsmall=3))
kable(p_table, align = c("l",rep("c",3))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Jags" = 3))

par(mar=c(5, 4, 4, 5))
ylim 		= c(-0.2, 0.9)
plot(1:9, p_table[c(21,1:8),Mean], xaxt="n",
    ylim=ylim, cex.axis=1, col = c("black",rep("grey51",8)),
    pch=15, xlab="POP", ylab="Main effect",
    main="Mixture baseline"
)

arrows(1:9, as.numeric(p_table[c(21,1:8),`2.5% CrI`]), 
       1:9, as.numeric(p_table[c(21,1:8),`97.5% CrI`]), 
       col = c("black",rep("grey51",8)),
       length=0.05, angle=90, code=3)
axis(1, at=1, labels=c("Overall\nmixture"), cex.axis = 0.75, 
     col.axis = c("black"))
axis(1, at=2:9, labels=c(pop), cex.axis = 0.75, 
     col.axis = c("grey51"))
axis(4, ylim=ylim, col="black",col.axis="grey51")
mtext("POP Weights",side=4,col="grey51",line = 3)
abline(h=0)
abline(v=1.5,col="red",lty=2)

par(mar=c(5, 4, 4, 5))
ylim 		= c(0, 0.55)
plot(1:9, p_table[c(22,9:16),Mean], xaxt="n",
    ylim=ylim, cex.axis=1, col = c("black",rep("grey51",8)),
    pch=15, xlab="POP", ylab="Main effect",
    main="Mixture interaction with age")
arrows(1:9, as.numeric(p_table[c(22,9:16),`2.5% CrI`]), 
       1:9, as.numeric(p_table[c(22,9:16),`97.5% CrI`]), 
       col = c("black",rep("grey51",8)),
       length=0.05, angle=90, code=3)
axis(1, at=1, labels=c("Overall\nmixture"), cex.axis = 0.75, 
     col.axis = c("black"))
axis(1, at=2:9, labels=c(pop), cex.axis = 0.75, 
     col.axis = c("grey51"))
axis(4, ylim=ylim, col="black",col.axis="grey51")
mtext("POP Weights",side=4,col="grey51",line = 3)
abline(h=0)
abline(v=1.5,col="red",lty=2)

```

# Stratified Male

```{r dataset_cleaning_male, echo=FALSE}
# load dataset
DT = read_xls("J:/PM/Colicino_Lab/Manuscripts/2020_Chatzi_USC/Data/base_long3.xls")
DT = as.data.table(DT)
#remove the outlier ID 392003
DT = DT[!childid %in% "392003"]

# list of chermicals and covariates
pop = c('HCB','DDE','PCB118','PCB153','PCB138','PCB156','PCB180','PCB170')
covariates = c("gender","mage","m_educ","parity","bmi_pre","age")

DT_pop = DT[,c('childid', 'timepoint', 'motherid', covariates, pop, "bmi"), with=F]
DT_pop = DT_pop[complete.cases(DT_pop)]
id_complete_cases = DT_pop[,.N,by=childid][N==3, childid]
DT_pop = DT_pop[childid %in% id_complete_cases]
DT_pop[, gender := as.numeric(gender-1)]
DT_pop = DT_pop[gender == 0]

X = DT_pop[,c(pop),with=F][!duplicated(DT_pop[,pop,with=F])]


# Quantile for pops
Xq = matrix(NA,NROW(X),NCOL(X))
colnames(Xq) = colnames(X)
for(i in 1:NCOL(X)) Xq[,i] = ecdf(X[[colnames(X)[i]]])(X[[colnames(X)[i]]])*3
X = as.data.frame(Xq)

Y = dcast(DT_pop, childid ~ timepoint, value.var = "bmi")[,c(2,3,4)]
Age = dcast(DT_pop, childid ~ timepoint, value.var = "age")[,c(2,3,4)]
Age = Age-mean(Age$`4`)
C = DT_pop[,c('childid',covariates[-6]),with=F][!duplicated(DT_pop[,c('childid',covariates[-6]),with=F])]
C[,':='(edu1 = ifelse(m_educ==1,1,0),
        edu2 = ifelse(m_educ==2,1,0),
        edu3 = ifelse(m_educ==3,1,0))]
C = C[,.(mage,parity,bmi_pre,edu2,edu3)]
cols = c('mage','bmi_pre')
C[ , (cols) := lapply(.SD, scale, center=T, scale=T), .SDcols = cols]
N = nrow(X)
timepoints = ncol(Age)
Q = ncol(C)
P = ncol(X)
alpha_w = rep(1,P)

jdata <- list(Y=Y, X=X, N=N, alpha_w = alpha_w, Age=Age, C=C, P=P, Q=Q, timepoints=timepoints)
var.s <- c("Wtilde","What","gamma0","gamma1","gamma2","gamma3","a.tau","c.tau")
model.fit <- jags.model(file=textConnection(mix_bwqs_model), data=jdata, n.chains=2, n.adapt=5000, quiet=T)
update(model.fit, n.iter=5000, progress.bar="none")
model.fit <- coda.samples(model=model.fit, variable.names=var.s, n.iter=300000, thin=60, progress.bar="none")
sm = summary(model.fit)

p_table = data.table(Parameters  = c(paste0("Wh_",pop),paste0("Wt_",pop),
                                     "sigma_a","sigma_c",
                                     "gamma0","gamma1","gamma2","gamma3"),
                     Mean        = format(round(sm$statistics[,1],3), digits=3, nsmall=3), 
                     `2.5% CrI`  = format(round(sm$quantiles[,1],3), digits=3, nsmall=3),
                     `97.5% CrI` = format(round(sm$quantiles[,5],3), digits=3, nsmall=3))
kable(p_table, align = c("l",rep("c",3))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Jags" = 3))

par(mar=c(5, 4, 4, 5))
ylim 		= c(-0.35, 0.9)
plot(1:9, p_table[c(21,1:8),Mean], xaxt="n",
    ylim=ylim, cex.axis=1, col = c("black",rep("grey51",8)),
    pch=15, xlab="POP", ylab="Main effect",
    main="Mixture baseline"
)

arrows(1:9, as.numeric(p_table[c(21,1:8),`2.5% CrI`]), 
       1:9, as.numeric(p_table[c(21,1:8),`97.5% CrI`]), 
       col = c("black",rep("grey51",8)),
       length=0.05, angle=90, code=3)
axis(1, at=1, labels=c("Overall\nmixture"), cex.axis = 0.75, 
     col.axis = c("black"))
axis(1, at=2:9, labels=c(pop), cex.axis = 0.75, 
     col.axis = c("grey51"))
axis(4, ylim=ylim, col="black",col.axis="grey51")
mtext("POP Weights",side=4,col="grey51",line = 3)
abline(h=0)
abline(v=1.5,col="red",lty=2)

par(mar=c(5, 4, 4, 5))
ylim 		= c(0, 0.55)
plot(1:9, p_table[c(22,9:16),Mean], xaxt="n",
    ylim=ylim, cex.axis=1, col = c("black",rep("grey51",8)),
    pch=15, xlab="POP", ylab="Main effect",
    main="Mixture interaction with age")
arrows(1:9, as.numeric(p_table[c(22,9:16),`2.5% CrI`]), 
       1:9, as.numeric(p_table[c(22,9:16),`97.5% CrI`]), 
       col = c("black",rep("grey51",8)),
       length=0.05, angle=90, code=3)
axis(1, at=1, labels=c("Overall\nmixture"), cex.axis = 0.75, 
     col.axis = c("black"))
axis(1, at=2:9, labels=c(pop), cex.axis = 0.75, 
     col.axis = c("grey51"))
axis(4, ylim=ylim, col="black",col.axis="grey51")
mtext("POP Weights",side=4,col="grey51",line = 3)
abline(h=0)
abline(v=1.5,col="red",lty=2)
```

# Stratified Female

```{r dataset_cleaning_female, echo=FALSE}
# load dataset
DT = read_xls("J:/PM/Colicino_Lab/Manuscripts/2020_Chatzi_USC/Data/base_long3.xls")
DT = as.data.table(DT)
#remove the outlier ID 392003
DT = DT[!childid %in% "392003"]

# list of chermicals and covariates
pop = c('HCB','DDE','PCB118','PCB153','PCB138','PCB156','PCB180','PCB170')
covariates = c("gender","mage","m_educ","parity","bmi_pre","age")

DT_pop = DT[,c('childid', 'timepoint', 'motherid', covariates, pop, "bmi"), with=F]
DT_pop = DT_pop[complete.cases(DT_pop)]
id_complete_cases = DT_pop[,.N,by=childid][N==3, childid]
DT_pop = DT_pop[childid %in% id_complete_cases]
DT_pop[, gender := as.numeric(gender-1)]
DT_pop = DT_pop[gender == 1]

X = DT_pop[,c(pop),with=F][!duplicated(DT_pop[,pop,with=F])]


# Quantile for pops
Xq = matrix(NA,NROW(X),NCOL(X))
colnames(Xq) = colnames(X)
for(i in 1:NCOL(X)) Xq[,i] = ecdf(X[[colnames(X)[i]]])(X[[colnames(X)[i]]])*3
X = as.data.frame(Xq)


Y = dcast(DT_pop, childid ~ timepoint, value.var = "bmi")[,c(2,3,4)]
Age = dcast(DT_pop, childid ~ timepoint, value.var = "age")[,c(2,3,4)]
Age = Age-mean(Age$`4`)
C = DT_pop[,c('childid',covariates[-6]),with=F][!duplicated(DT_pop[,c('childid',covariates[-6]),with=F])]
C[,':='(edu1 = ifelse(m_educ==1,1,0),
        edu2 = ifelse(m_educ==2,1,0),
        edu3 = ifelse(m_educ==3,1,0))]
C = C[,.(mage,parity,bmi_pre,edu2,edu3)]
cols = c('mage','bmi_pre')
C[ , (cols) := lapply(.SD, scale, center=T, scale=T), .SDcols = cols]
N = nrow(X)
timepoints = ncol(Age)
Q = ncol(C)
P = ncol(X)
alpha_w = rep(1,P)

jdata <- list(Y=Y, X=X, N=N, alpha_w = alpha_w, Age=Age, C=C, P=P, Q=Q, timepoints=timepoints)
var.s <- c("Wtilde","What","gamma0","gamma1","gamma2","gamma3","a.tau","c.tau")
model.fit <- jags.model(file=textConnection(mix_bwqs_model), data=jdata, n.chains=2, n.adapt=5000, quiet=T)
update(model.fit, n.iter=5000, progress.bar="none")
model.fit <- coda.samples(model=model.fit, variable.names=var.s, n.iter=300000, thin=60, progress.bar="none")
sm = summary(model.fit)

p_table = data.table(Parameters  = c(paste0("Wh_",pop),paste0("Wt_",pop),
                                     "sigma_a","sigma_c",
                                     "gamma0","gamma1","gamma2","gamma3"),
                     Mean        = format(round(sm$statistics[,1],3), digits=3, nsmall=3), 
                     `2.5% CrI`  = format(round(sm$quantiles[,1],3), digits=3, nsmall=3),
                     `97.5% CrI` = format(round(sm$quantiles[,5],3), digits=3, nsmall=3))
kable(p_table, align = c("l",rep("c",3))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  add_header_above(c(" " = 1, "Jags" = 3))

par(mar=c(5, 4, 4, 5))
ylim 		= c(-0.2, 1.2)
plot(1:9, p_table[c(21,1:8),Mean], xaxt="n",
    ylim=ylim, cex.axis=1, col = c("black",rep("grey51",8)),
    pch=15, xlab="POP", ylab="Main effect",
    main="Mixture baseline"
)

arrows(1:9, as.numeric(p_table[c(21,1:8),`2.5% CrI`]), 
       1:9, as.numeric(p_table[c(21,1:8),`97.5% CrI`]), 
       col = c("black",rep("grey51",8)),
       length=0.05, angle=90, code=3)
axis(1, at=1, labels=c("Overall\nmixture"), cex.axis = 0.75, 
     col.axis = c("black"))
axis(1, at=2:9, labels=c(pop), cex.axis = 0.75, 
     col.axis = c("grey51"))
axis(4, ylim=ylim, col="black",col.axis="grey51")
mtext("POP Weights",side=4,col="grey51",line = 3)
abline(h=0)
abline(v=1.5,col="red",lty=2)

par(mar=c(5, 4, 4, 5))
ylim 		= c(-0.1, 0.55)
plot(1:9, p_table[c(22,9:16),Mean], xaxt="n",
    ylim=ylim, cex.axis=1, col = c("black",rep("grey51",8)),
    pch=15, xlab="POP", ylab="Main effect",
    main="Mixture interaction with age")
arrows(1:9, as.numeric(p_table[c(22,9:16),`2.5% CrI`]), 
       1:9, as.numeric(p_table[c(22,9:16),`97.5% CrI`]), 
       col = c("black",rep("grey51",8)),
       length=0.05, angle=90, code=3)
axis(1, at=1, labels=c("Overall\nmixture"), cex.axis = 0.75, 
     col.axis = c("black"))
axis(1, at=2:9, labels=c(pop), cex.axis = 0.75, 
     col.axis = c("grey51"))
axis(4, ylim=ylim, col="black",col.axis="grey51")
mtext("POP Weights",side=4,col="grey51",line = 3)
abline(h=0)
abline(v=1.5,col="red",lty=2)
```




